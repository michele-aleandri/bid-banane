<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puerto Banana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #03a9f4;
        }
        .bangers-font {
            font-family: 'Bangers', cursive;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 text-white">

    <!-- Start screen -->
    <div id="start-screen" class="flex flex-col items-center justify-center space-y-8 text-center">
        <h1 class="text-6xl md:text-8xl bangers-font text-yellow-300 drop-shadow-lg">PUERTO BANANA</h1>
        <p class="text-xl md:text-2xl max-w-2xl font-semibold">
            Welcome to Puerto Banana! The docks are full of bananas and your goal is to load your ship to have more bananas than your opponents. Be shrewd and win the auctions!
        </p>
        <div class="space-y-4">
            <div>
                <label for="player-count" class="block text-lg font-semibold mb-2">Number of players (2-6):</label>
                <input type="number" id="player-count" value="2" min="2" max="6" class="p-2 w-24 text-center rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-yellow-500">
            </div>
            <button id="next-step-btn" class="px-6 py-3 bg-yellow-400 text-black text-xl font-bold rounded-full shadow-lg hover:bg-yellow-500 transition-colors duration-200">
                Next
            </button>
        </div>
    </div>

    <!-- Name input screen -->
    <div id="name-input-screen" class="hidden flex-col items-center justify-center space-y-6 text-center w-full max-w-xl">
        <h2 class="text-4xl bangers-font text-yellow-300 drop-shadow-lg">Enter player names</h2>
        <div id="name-inputs" class="w-full space-y-4">
            <!-- Inputs will be inserted here by JavaScript -->
        </div>
        <button id="start-game-btn" class="px-6 py-3 bg-yellow-400 text-black text-xl font-bold rounded-full shadow-lg hover:bg-yellow-500 transition-colors duration-200">
            Start game
        </button>
    </div>

    <!-- Game screen -->
    <div id="game-screen" class="hidden flex-col items-center w-full max-w-5xl space-y-6">

        <!-- Top area: game info -->
        <div class="w-full flex justify-between items-center bg-blue-700 p-4 rounded-xl shadow-lg">
            <h2 id="round-info" class="text-xl md:text-2xl font-bold">Round 1</h2>
            <div class="text-lg md:text-xl font-bold flex items-center">
                Bananas for auction:
                <div id="bananas-for-auction" class="ml-2 px-4 py-2 bg-yellow-400 text-black rounded-lg shadow-inner">0</div>
            </div>
            <div class="text-sm md:text-base font-semibold">
                Turn of: <span id="current-player-turn" class="font-bold"></span>
            </div>
        </div>

        <!-- Players grid -->
        <div id="players-grid" class="w-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            <!-- Players will be inserted here by JavaScript -->
        </div>

        <!-- Bid control panel -->
        <div id="bid-panel" class="w-full flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mt-6 p-6 bg-blue-700 rounded-xl shadow-lg">
            <h3 id="bid-player-name" class="text-xl font-bold md:w-1/3 text-center md:text-left"></h3>
            <div class="flex items-center space-x-2 md:w-1/3 justify-center">
                <label for="player-bid" class="text-lg">Your bid:</label>
                <input type="number" id="player-bid" class="w-24 p-2 text-center rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-yellow-500" min="0" inputmode="numeric">
            </div>
            <button id="submit-bid-btn" class="px-6 py-3 bg-yellow-400 text-black font-bold rounded-full shadow-lg hover:bg-yellow-500 transition-colors duration-200 md:w-1/3">
                Submit bid
            </button>
        </div>

        <!-- Game message modal -->
        <div id="game-message-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4">
            <div class="bg-blue-800 p-8 rounded-xl shadow-2xl text-center max-w-md w-full">
                <h4 id="modal-title" class="text-3xl font-bold mb-4 bangers-font text-yellow-300"></h4>
                <p id="modal-message" class="text-lg mb-6"></p>
                <button id="modal-btn" class="px-6 py-3 bg-yellow-400 text-black font-bold rounded-full shadow-lg hover:bg-yellow-500 transition-colors duration-200">
                    Continue
                </button>
            </div>
        </div>

    </div>

    <!-- End screen -->
    <div id="end-screen" class="hidden flex-col items-center text-center space-y-6">
        <h2 class="text-5xl md:text-6xl bangers-font text-yellow-300 drop-shadow-lg">Game Over!</h2>
        <div id="winners" class="text-2xl font-bold"></div>
        <div id="final-scores" class="w-full max-w-lg mt-4 bg-blue-700 p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-bold mb-4">Final Scoreboard</h3>
            <ul id="score-list" class="space-y-2"></ul>
        </div>
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
            <button id="download-data-btn" class="px-6 py-3 bg-yellow-400 text-black font-bold rounded-full shadow-lg hover:bg-yellow-500 transition-colors duration-200">
                Export Data to Excel
            </button>
            <button id="restart-game-btn" class="px-6 py-3 bg-red-400 text-black font-bold rounded-full shadow-lg hover:bg-red-500 transition-colors duration-200">
                Play Again
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let players = [];
            let round = 0;
            let bids = [];
            let playerTurnIndex = 0;
            const history = [];
            // Variabile non piÃ¹ necessaria, ora il valore viene letto direttamente dall'input.

            const startScreen = document.getElementById('start-screen');
            const nameInputScreen = document.getElementById('name-input-screen');
            const gameScreen = document.getElementById('game-screen');
            const endScreen = document.getElementById('end-screen');
            const nextStepBtn = document.getElementById('next-step-btn');
            const startGameBtn = document.getElementById('start-game-btn');
            const playerCountInput = document.getElementById('player-count');
            const nameInputsContainer = document.getElementById('name-inputs');
            const playersGrid = document.getElementById('players-grid');
            const roundInfo = document.getElementById('round-info');
            const bananasForAuctionEl = document.getElementById('bananas-for-auction');
            const bidPanel = document.getElementById('bid-panel');
            const bidPlayerName = document.getElementById('bid-player-name');
            const playerBidInput = document.getElementById('player-bid');
            const submitBidBtn = document.getElementById('submit-bid-btn');
            const gameMessageModal = document.getElementById('game-message-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalBtn = document.getElementById('modal-btn');
            const winnersEl = document.getElementById('winners');
            const finalScoresList = document.getElementById('score-list');
            const downloadDataBtn = document.getElementById('download-data-btn');
            const restartGameBtn = document.getElementById('restart-game-btn');
            const currentPlayerTurnEl = document.getElementById('current-player-turn');

            const getRandomColor = () => {
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            };

            const saveState = () => {
                localStorage.setItem('puertoBananaState', JSON.stringify({ players, round, bids, playerTurnIndex, history }));
            };

            const loadState = () => {
                const savedState = localStorage.getItem('puertoBananaState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    players = state.players;
                    round = state.round;
                    bids = state.bids;
                    playerTurnIndex = state.playerTurnIndex;
                    history = state.history;
                }
            };

            const showModal = (title, message) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                gameMessageModal.classList.remove('hidden');
            };

            const hideModal = () => {
                gameMessageModal.classList.add('hidden');
            };

            const showScreen = (screenId) => {
                [startScreen, nameInputScreen, gameScreen, endScreen].forEach(screen => {
                    screen.classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            };

            const createPlayerCard = (player) => {
                const card = document.createElement('div');
                card.id = `player-${player.id}`;
                card.classList.add('bg-blue-900', 'p-6', 'rounded-xl', 'shadow-xl', 'text-center', 'space-y-4');
                card.innerHTML = `
                    <h3 class="text-xl md:text-2xl font-bold italic" style="color: ${player.color};">${player.name}</h3>
                    <div class="text-lg">Banana Stock: <span id="stock-${player.id}" class="font-bold text-yellow-400 text-3xl">${player.stock}</span></div>
                    <div class="text-lg">Last bid: <span id="bid-${player.id}" class="font-bold">${player.lastBid !== null ? player.lastBid : 'N/A'}</span></div>
                `;
                return card;
            };

            const renderPlayers = () => {
                playersGrid.innerHTML = '';
                players.forEach(player => {
                    playersGrid.appendChild(createPlayerCard(player));
                });
            };

            const updatePlayerCard = (playerId, stock, lastBid) => {
                const stockEl = document.getElementById(`stock-${playerId}`);
                if (stockEl) {
                    stockEl.textContent = stock;
                }
                const bidEl = document.getElementById(`bid-${playerId}`);
                if (bidEl) {
                    bidEl.textContent = lastBid !== null ? lastBid : 'N/A';
                }
            };

            const getHighestStock = () => {
                return Math.max(...players.map(p => p.stock));
            };

            const newRound = () => {
                // Update player cards with previous round's bids
                bids.forEach(bid => {
                    const player = players.find(p => p.id === bid.playerId);
                    if (player) {
                        player.lastBid = bid.bid;
                        updatePlayerCard(player.id, player.stock, player.lastBid);
                    }
                });

                round++;
                roundInfo.textContent = `Round ${round}`;
                bids = [];
                const bananasForAuction = getHighestStock();
                bananasForAuctionEl.textContent = bananasForAuction;
                playerTurnIndex = 0;
                setBidPanelForCurrentPlayer();
                saveState();
            };

            const setBidPanelForCurrentPlayer = () => {
                if (playerTurnIndex < players.length) {
                    const currentPlayer = players[playerTurnIndex];
                    bidPanel.classList.remove('hidden');
                    bidPlayerName.textContent = `Turn of ${currentPlayer.name}`;
                    bidPlayerName.style.color = currentPlayer.color;
                    currentPlayerTurnEl.textContent = currentPlayer.name;
                    currentPlayerTurnEl.style.color = currentPlayer.color;
                    playerBidInput.value = '';
                } else {
                    bidPanel.classList.add('hidden');
                    currentPlayerTurnEl.textContent = 'Calculating results...';
                    currentPlayerTurnEl.style.color = '';
                    calculateResults();
                }
            };

            const calculateResults = () => {
                const bananasForAuction = parseInt(bananasForAuctionEl.textContent);
                let message = '';
                
                // Filter for valid bids (greater than 0)
                let currentBids = bids.filter(b => b.bid > 0);
                
                // Sort bids from highest to lowest
                currentBids.sort((a, b) => b.bid - a.bid);
                
                // If there are no valid bids, the round ends
                if (currentBids.length === 0) {
                    message = "No bids this round. Bananas were not assigned.";
                    showModal('Round Results', message);
                    modalBtn.onclick = () => {
                        hideModal();
                        checkEndGame();
                    };
                    return;
                }
                
                let roundMessage = '';
                let auctionResolved = false;

                while (!auctionResolved && currentBids.length > 0) {
                    // Handle ties for the highest bid
                    const highestBid = currentBids[0].bid;
                    const highestBidders = currentBids.filter(b => b.bid === highestBid);

                    if (highestBidders.length > 1) {
                        const winningPlayers = highestBidders.map(b => players.find(p => p.id === b.playerId));
                        const bananasPerPlayer = Math.floor(bananasForAuction / winningPlayers.length);
                        
                        winningPlayers.forEach(p => {
                            p.stock += bananasPerPlayer;
                        });
                        
                        roundMessage += `Tie between ${winningPlayers.map(p => p.name).join(', ')}. Each receives ${bananasPerPlayer} bananas. No bonus paid.`;
                        auctionResolved = true;
                        break;
                    }
                    
                    const potentialWinnerBid = highestBidders[0];
                    const potentialWinner = players.find(p => p.id === potentialWinnerBid.playerId);
                    
                    const secondHighestBidder = currentBids.length > 1 ? currentBids[1] : null;
                    const bonus = secondHighestBidder ? potentialWinnerBid.bid - secondHighestBidder.bid : 0;
                    
                    // Add bananas at stake to the potential winner's stock for calculation
                    const potentialStockAfterWinnings = potentialWinner.stock + bananasForAuction;
                    
                    if (potentialStockAfterWinnings >= bonus) {
                        // The winner can pay the bonus, the round is won
                        potentialWinner.stock = potentialStockAfterWinnings - bonus;
                        if (bonus > 0) {
                            const secondHighestBidders = currentBids.filter(b => b.bid === secondHighestBidder.bid);
                            const bonusPerPlayer = Math.floor(bonus / secondHighestBidders.length);
                            secondHighestBidders.forEach(b => {
                                const player = players.find(p => p.id === b.playerId);
                                player.stock += bonusPerPlayer;
                            });
                        }
                        
                        roundMessage += `The winner is ${potentialWinner.name} with a bid of ${potentialWinnerBid.bid}. Receives ${bananasForAuction} bananas. Will pay a bonus of ${bonus}.`;
                        auctionResolved = true;
                    } else {
                        // The winner cannot pay the bonus
                        roundMessage += `${potentialWinner.name} cannot pay the bonus of ${bonus} and is removed from the auction, losing all their stock.\n`;
                        potentialWinner.stock = 0;
                        potentialWinner.lastBid = 'Removed';
                        updatePlayerCard(potentialWinner.id, potentialWinner.stock, potentialWinner.lastBid);
                        currentBids = currentBids.filter(b => b.playerId !== potentialWinner.id);

                        // If only one player remains, they win everything
                        if (currentBids.length === 1) {
                            const lastPlayer = players.find(p => p.id === currentBids[0].playerId);
                            lastPlayer.stock += bananasForAuction;
                            roundMessage += `${lastPlayer.name} is the last player remaining and wins all ${bananasForAuction} bananas without a bonus.`;
                            auctionResolved = true;
                        } else if (currentBids.length === 0) {
                            roundMessage += "No player could pay the bonus. The bananas were not assigned.";
                            auctionResolved = true;
                        }
                    }
                }
                
                // Save round data to history
                history.push({
                    round: round,
                    bananasForAuction: bananasForAuction,
                    bids: bids.map(b => ({
                        playerId: b.playerId,
                        playerName: players.find(p => p.id === b.playerId).name,
                        bid: b.bid
                    })),
                    results: roundMessage,
                    stocks: players.map(p => ({
                        playerName: p.name,
                        stock: p.stock
                    }))
                });
                saveState();

                showModal('Round Results', roundMessage);
                modalBtn.onclick = () => {
                    hideModal();
                    checkEndGame();
                };
            };


            const checkEndGame = () => {
                const gameEnded = players.some(p => p.stock >= 200);
                if (gameEnded) {
                    endGame();
                } else {
                    newRound();
                }
            };

            const endGame = () => {
                showScreen('end-screen');
                const sortedPlayers = [...players].sort((a, b) => b.stock - a.stock);
                const winnerStock = sortedPlayers[0].stock;
                const winners = sortedPlayers.filter(p => p.stock === winnerStock);

                if (winners.length > 1) {
                    winnersEl.textContent = `The winners are ${winners.map(p => p.name).join(' and ')} with ${winnerStock} bananas! (Tie)`;
                } else {
                    winnersEl.textContent = `The winner is ${winners[0].name} with ${winnerStock} bananas!`;
                }

                finalScoresList.innerHTML = '';
                sortedPlayers.forEach(p => {
                    const li = document.createElement('li');
                    li.classList.add('flex', 'justify-between', 'items-center', 'font-semibold');
                    li.innerHTML = `
                        <span>${p.name}</span>
                        <span class="text-yellow-400">${p.stock} bananas</span>
                    `;
                    finalScoresList.appendChild(li);
                });
                saveState();
            };

            const exportToExcel = () => {
                const header = ["Round", "Bananas at stake", "Player Name", "Bid", "Final Stock"];
                let csvContent = header.join(";") + "\n";
                
                history.forEach(roundData => {
                    const bananasForAuction = roundData.bananasForAuction;
                    roundData.bids.forEach(bid => {
                        const stockFinale = roundData.stocks.find(p => p.playerName === bid.playerName).stock;
                        csvContent += `${roundData.round};${bananasForAuction};${bid.playerName};${bid.bid};${stockFinale}\n`;
                    });
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `PuertoBanana_GameData_${Date.now()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // Event listener for the "Next" button (after entering the number of players)
            nextStepBtn.addEventListener('click', () => {
                const playerCount = parseInt(playerCountInput.value, 10);
                if (playerCount >= 2 && playerCount <= 6) {
                    showScreen('name-input-screen');
                    nameInputsContainer.innerHTML = '';
                    for (let i = 0; i < playerCount; i++) {
                        const div = document.createElement('div');
                        div.classList.add('flex', 'flex-col', 'sm:flex-row', 'items-center', 'sm:justify-between');
                        div.innerHTML = `
                            <label for="player-name-${i}" class="text-lg mb-1 sm:mb-0 sm:mr-4">Player ${i + 1}:</label>
                            <input type="text" id="player-name-${i}" placeholder="Enter name" class="p-2 w-full sm:w-64 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        `;
                        nameInputsContainer.appendChild(div);
                    }
                } else {
                    showModal('Error', 'Enter a valid number of players (2 to 6).');
                }
            });

            // Event listener for the "Start game" button (after entering names)
            startGameBtn.addEventListener('click', () => {
                const playerCount = parseInt(playerCountInput.value, 10);
                players = [];
                let allNamesValid = true;
                for (let i = 0; i < playerCount; i++) {
                    const nameInput = document.getElementById(`player-name-${i}`);
                    const name = nameInput.value.trim();
                    if (name === '') {
                        allNamesValid = false;
                        break;
                    }
                    players.push({
                        id: i,
                        name: name,
                        stock: 10,
                        lastBid: null,
                        color: getRandomColor()
                    });
                }

                if (allNamesValid) {
                    round = 0;
                    bids = [];
                    history.length = 0;
                    renderPlayers();
                    showScreen('game-screen');
                    newRound();
                } else {
                    showModal('Error', 'Make sure to enter a name for each player.');
                }
            });

            // Rimosso il gestore che nascondeva l'input. Ora il valore rimane visibile.
            // L'input accetta solo numeri grazie a type="number".
            playerBidInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevents form submission
                    submitBidBtn.click(); // Simulates button click
                }
            });

            // Adds "Enter" key functionality to the modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !gameMessageModal.classList.contains('hidden')) {
                    e.preventDefault();
                    modalBtn.click();
                }
            });

            submitBidBtn.addEventListener('click', () => {
                const currentPlayer = players[playerTurnIndex];
                const bidValue = parseInt(playerBidInput.value, 10); // Legge il valore direttamente dall'input

                if (playerBidInput.value.trim() === '' || isNaN(bidValue) || bidValue < 0) {
                    showModal('Error', 'Enter a valid numeric value for the bid.');
                    modalBtn.onclick = () => {
                        hideModal();
                        playerBidInput.value = '';
                    };
                    return;
                }

                bids.push({ playerId: currentPlayer.id, bid: bidValue });
                // The `updatePlayerCard` line was removed from here to not show the bid immediately

                showModal('Bid Submitted', `${currentPlayer.name}, your bid has been submitted. Pass to the next player.`);
                modalBtn.onclick = () => {
                    hideModal();
                    playerTurnIndex++;
                    setBidPanelForCurrentPlayer();
                };
            });

            downloadDataBtn.addEventListener('click', exportToExcel);
            restartGameBtn.addEventListener('click', () => {
                localStorage.clear();
                window.location.reload();
            });

            // Start the game
            showScreen('start-screen');
        });
    </script>
</body>
</html>
